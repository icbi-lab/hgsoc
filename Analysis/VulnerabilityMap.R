# Load necessary libraries
library(ggplot2)
library(ggpubr)
library(rstatix)
library(tidyverse)
library(maps)
library(ggfx)
library(GSVA)
library(dplyr)
library(reshape2)
library(sigmoid)
library(limma)
library(survival)
library(beeswarm)
library("RColorBrewer")
library(tidyverse)

# Set a seed for reproducibility
set.seed(1)

# Define a function to map values using a logistic function with softmax preprocessing
mapping = function(x) {
  v = x
  # Map using a logistic function with parameters based on the mean and standard deviation from a specific dataset
  w = 1/(1+exp(-((x-mean(data_matrix_TCGA$ratio_CYT_C1QA))/(sd(data_matrix_TCGA$ratio_CYT_C1QA)/pi))))
  return(w)
}

# Define another mapping function with softmax preprocessing
mapping2 = function(x) {
  v = x
  # Map using a logistic function with parameters based on mean and standard deviation
  w = 1/(1+exp(-(x-(mean(data_matrix_TCGA$VulnerabilityScore)/sd(data_matrix_TCGA$VulnerabilityScore)/pi))))
  return(w)
}  

# Define a gradient color scale for plots
sc <- scale_colour_gradientn(colours = c('blue','#EEAA0D',"red"))

# Load the Topacio dataset and metadata
data_TOPACIO = read.csv('NoramlizedData_annotated.csv', row.names = 1)
meta_TOPACIO = read.csv('Faekilae_meta.csv', row.names = 1)

# Order the data and metadata by row names to ensure alignment
data_TOPACIO = data_TOPACIO[order(row.names(data_TOPACIO)), ]
meta_TOPACIO = meta_TOPACIO[order(row.names(meta_TOPACIO)), ]

# Combine the data and metadata into one dataframe
data_TOPACIO <- cbind(data_TOPACIO, meta_TOPACIO)

# Exclude unspecified responders from the dataset
data_TOPACIO <- data_TOPACIO[!(data_TOPACIO$Responder=="Not_spcified"),]

# Convert the responder status to a binary integer variable
data_TOPACIO$ResponderInt = as.numeric(data_TOPACIO$Responder == 'Responder')

# Calculate the cytotoxicity (CYT) score as the average of two markers
data_TOPACIO$CYT <- (data_TOPACIO$GZMB + data_TOPACIO$PRF1) / 2

# Calculate the ratio between CYT and C1QA
data_TOPACIO$Ratio <- data_TOPACIO$CYT - data_TOPACIO$C1QA

# Perform logistic regression analysis using the glm function
logit <- glm(ResponderInt ~ Sig3 + Ratio, family = binomial, data = data_TOPACIO)

# Extract the coefficients from the regression model
coefficients = as.data.frame(logit$coefficients)
coefRatio = coefficients['Ratio', 1]
coefBRCAness = coefficients['Sig3', 1]

# Create a background "map" using matrix arithmetic and the image function
x3 = seq(0, 1, length.out = 500)
y3 = seq(0, 1, length.out = 500)
matrix_result <- outer((x3 * coefRatio), (y3 * coefBRCAness), "+")
image(matrix_result, col = colorRampPalette(c("blue", '#EEAA0D', "red"))(1000), axes = FALSE, main = "Matrix as a Map")

# Perform analysis on TCGA data
data_matrix_TCGA = read.csv('DataMatrix.csv', row.names = 1)
exp_data_TCGA = read.csv('log2TPMs.csv', row.names = 1)

# Order the expression data and the data matrix by row names
exp_data_TCGA = exp_data_TCGA[order(row.names(exp_data_TCGA)), ]
data_matrix_TCGA = data_matrix_TCGA[order(row.names(data_matrix_TCGA)), ]

# Merge the expression data with the data matrix
data_matrix_TCGA = merge(data_matrix_TCGA, exp_data_TCGA, all.x = TRUE, by = "row.names")

# Remove a specific sample from the dataset
data_matrix_TCGA_test = subset(data_matrix_TCGA, Row.names != 'TCGA-24-1549')


# Calculate the CYT score and its ratio to C1QA
data_matrix_TCGA$CYT = (data_matrix_TCGA$GZMB + data_matrix_TCGA$PRF1) / 2
data_matrix_TCGA['ratio_CYT_C1QA'] = data_matrix_TCGA$CYT / data_matrix_TCGA$C1QA
data_matrix_TCGA['ratio_CYT_C1QA_mapped'] = mapping(data_matrix_TCGA$ratio_CYT_C1QA)

# Calculate the vulnerability score using the mapped ratio and BRCAness probability
data_matrix_TCGA$VulnerabilityScore <- coefBRCAness * data_matrix_TCGA$BRCAness_prob + coefRatio * data_matrix_TCGA$ratio_CYT_C1QA_mapped
data_matrix_TCGA$VulnerabilityScore_raw <- coefBRCAness * data_matrix_TCGA$BRCAness_prob + coefRatio * data_matrix_TCGA$ratio_CYT_C1QA

# Plot the relationship between the vulnerability score and its raw counterpart
ggplot(data_matrix_TCGA, aes(VulnerabilityScore, VulnerabilityScore_raw)) +
  geom_point()

# Prepare the data for plotting, including the score and labels
x1 = data_matrix_TCGA$ratio_CYT_C1QA_mapped
y1 = as.numeric(data_matrix_TCGA$BRCAness_prob)
labels = data_matrix_TCGA$Row.names

data_plot_tcga = data.frame(
  x = x1,
  y = y1,
  score = coefBRCAness * y1 + coefRatio * x1,
  labels = labels
)

# Plot the data with text labels
ggplot(data_plot_tcga, aes(x, y, label = labels)) +
  geom_text()

# Plot the data with points colored by the score
ggplot(data_plot_tcga, aes(x, y, color = score, size = 2)) +
  geom_point() +
  sc

# Analysis of Mui data
exp_mui = read.csv('log2_TPMs.csv', row.names = 1)
exp_mui = as.data.frame(t(exp_mui))
data_mui = read.csv('DataMatrix.csv', row.names = 1)

# Order the Mui data and expression data by row names
exp_mui = exp_mui[order(row.names(exp_mui)), ]
data_mui = data_mui[order(row.names(data_mui)), ]

# Combine the data matrices
data_mui = cbind(data_mui, exp_mui)

# Calculate the CYT score and ratio for the Mui data
data_mui['CYT'] = (data_mui$GZMB + data_mui$PRF1) / 2
data_mui['ratio_CYT_C1QA'] = (data_mui$GZMB + data_mui$PRF1) / data_mui$C1QA

# Apply the mapping function and calculate the vulnerability scores for the Mui data
data_mui['ratio_CYT_C1QA_mapped'] = mapping(data_mui$ratio_CYT_C1QA)
data_mui$VulnerabilityScore <- coefBRCAness * data_mui$BRCAness_prob + coefRatio * data_mui$ratio_CYT_C1QA_mapped
data_mui$VulnerabilityScore_raw <- coefBRCAness * data_mui$BRCAness_prob + coefRatio * data_mui$ratio_CYT_C1QA

# Prepare the Mui data for plotting
x2 = data_mui$ratio_CYT_C1QA_mapped
y2 = as.numeric(data_mui$BRCAness_prob)
labels = rownames(data_mui)

data_plot_mui = data.frame(
  x = x2,
  y = y2,
  score = coefBRCAness * y2 + coefRatio * x2,
  labels = labels
)

# Plot the Mui data with text labels
ggplot(data_plot_mui, aes(x, y, label = labels)) +
  geom_text()

# Write the TCGA and Mui data matrices to output files
write.table(data_matrix_TCGA, file = 'DataMatrix_VulnerabilityScore_and_expression_TCGA.txt', sep = '\t')
df_data_matrix_TCGA <- data_matrix_TCGA[, !(names(data_matrix_TCGA) %in% c(names(exp_data_TCGA)))]
write.table(df_data_matrix_TCGA, file = 'CGA/DataMatrix_VulnerabilityScore_TCGA.txt', sep = '\t')

write.table(data_mui,file = '/data/projects/2020/OvarianCancerHH/OV_Project/Results/MUI/DataMatrix_VulnerabilityScore_and_expression_MUI.txt',sep = '\t')
df_data_matrix_MUI <- data_mui[, !(names(data_mui) %in% c(names(exp_mui)))]
write.table(df_data_matrix_MUI,file = '/data/projects/2020/OvarianCancerHH/OV_Project/Results/MUI/DataMatrix_VulnerabilityScore_MUI.txt',sep = '\t')
